<!DOCTYPE html>
<html lang="tr">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kompresor Kontrol</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  background:#0e0e0e;
  color:white;
  text-align:center;
  font-family:Arial;
  margin:0;
  padding:0;
}

.btn {
  width:80%;
  max-width:300px;
  padding:20px;
  margin:15px auto;
  font-size:22px;
  font-weight:bold;
  border:none;
  border-radius:14px;
  color:white;
  transition:0.15s;
  display:block;
}

.btn-start { background:#00c853; }
.btn-stop  { background:#d50000; }

.disabled {
  opacity:0.35;
  pointer-events:none;
  filter:grayscale(100%);
}

.btn:active { transform:scale(0.92); }

@keyframes vibrate {
  0% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  50% { transform: translateX(3px); }
  75% { transform: translateX(-3px); }
  100% { transform: translateX(0); }
}

.vibrate { animation:vibrate 0.15s linear; }

/* --- Overlay --- */
#overlay {
  position: fixed;
  inset:0;
  background: rgba(0,0,0,0.85);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight:bold;
  z-index: 9999;
  text-align: center;
}
</style>
</head>

<body>

<h2>KompresÃ¶r Kontrol</h2>
<h2>( Made in Ersin )</h2>

<button id="btnStart" class="btn btn-start disabled">ðŸŸ¢ START</button>
<button id="btnStop"  class="btn btn-stop disabled">ðŸ”´ STOP</button>

<!-- Offline / Cihaz BaÄŸlanÄ±yor Overlay -->
<div id="overlay">Cihaz baÄŸlanÄ±yor veya offline</div>

<script>
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const overlay  = document.getElementById("overlay");

let online = false;
let startState = 0;
let stopState  = 0;

/* ðŸ”´ Telefon offline kontrolÃ¼ */
function phoneOffline() {
  return !navigator.onLine;
}

/* --- Buton ve overlay kontrolÃ¼ --- */
function updateUI() {
  // Telefon offline veya ESP32 offline â†’ overlay aÃ§Ä±k, butonlar kilitli
  if (phoneOffline() || !online) {
    overlay.style.display = "flex";
    btnStart.classList.add("disabled");
    btnStop.classList.add("disabled");
    return;
  }

  // RÃ¶le aktifse â†’ overlay aÃ§Ä±k ve butonlar kilitli
  if (startState === 1 || stopState === 1) {
    overlay.style.display = "flex";
    btnStart.classList.add("disabled");
    btnStop.classList.add("disabled");
    return;
  }

  // Her ÅŸey normal â†’ overlay gizli, butonlar aktif
  overlay.style.display = "none";
  btnStart.classList.remove("disabled");
  btnStop.classList.remove("disabled");
}

/* --- Telefon online/offline olaylarÄ± --- */
window.addEventListener("offline", updateUI);
window.addEventListener("online", updateUI);

/* --- MQTT BaÄŸlantÄ±sÄ± --- */
const client = mqtt.connect(
  "wss://356d2463ef40488694ce4fe2d4a23976.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username:"wersin3230",
    password:"We112233",
    keepalive:60,
    reconnectPeriod:2000
  }
);

client.on("connect", () => {
  online = false; // durum kontrol edilecek
  updateUI();
  client.subscribe("esp32/status");
  client.subscribe("esp32/start_state");
  client.subscribe("esp32/stop_state");
});

client.on("close",   () => { online = false; updateUI(); });
client.on("offline", () => { online = false; updateUI(); });
client.on("error",   () => { online = false; updateUI(); });

client.on("message", (topic, message) => {
  const val = message.toString();

  if (topic === "esp32/status") {
    online = (val === "1");
  }

  if (topic === "esp32/start_state") {
    startState = (val === "1") ? 1 : 0;
  }

  if (topic === "esp32/stop_state") {
    stopState = (val === "1") ? 1 : 0;
  }

  updateUI();
});

/* --- Animasyon + titreÅŸim --- */
function vibrateAndAnimate(btn) {
  if (navigator.vibrate) navigator.vibrate(50);
  btn.classList.add("vibrate");
  setTimeout(() => btn.classList.remove("vibrate"), 150);
}

/* --- Buton click --- */
btnStart.onclick = () => {
  if (phoneOffline() || !online) return;
  client.publish("esp32/start","1");
  vibrateAndAnimate(btnStart);
};

btnStop.onclick = () => {
  if (phoneOffline() || !online) return;
  client.publish("esp32/stop","1");
  vibrateAndAnimate(btnStop);
};

/* --- Sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz offline kontrolÃ¼ --- */
updateUI();
</script>

</body>
</html>











