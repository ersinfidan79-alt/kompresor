<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>KOMPRESOR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
    height: 100%;
    margin: 0;
    font-family: Segoe UI, Tahoma;
    background: linear-gradient(to bottom right, #74ebd5, #ACB6E5);
    display: flex;
    justify-content: center;
    align-items: center;
}

/* ---------- PIN7 LED ---------- */
#pinLedBox {
    position: fixed;
    top: 15px;
    width: 100%;
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 9999;
}

#pinLed {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: red;
    animation: pulse 1.2s infinite;
}

#pinText {
    margin-top: 6px;
    color: white;
    font-weight: bold;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
}

@keyframes pulse {
    0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
    70%  { box-shadow: 0 0 0 12px rgba(255,255,255,0); }
    100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
}

/* ---------- UI ---------- */
.container {
    width: 95%;
    max-width: 480px;
    text-align: center;
}

h2 { color: white; }

.button-group {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

button {
    font-size: 1.8em;
    padding: 18px;
    border: none;
    border-radius: 18px;
    color: white;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    cursor: pointer;
}

button.disabled {
    opacity: 0.4;
    pointer-events: none;
}

#btnConnect { background: linear-gradient(135deg,#007bff,#00bfff); }
#btnStart   { background: linear-gradient(135deg,#28a745,#218838); }
#btnStop    { background: linear-gradient(135deg,#dc3545,#ff4c4c); }
#btnReset   { background: linear-gradient(135deg,#8e44ad,#c0392b); }
</style>
</head>

<body>

<div id="pinLedBox">
    <div id="pinLed"></div>
    <div id="pinText">KAPALI</div>
</div>

<div class="container">
    <h2>Bluetooth</h2>
    <div class="button-group">
        <button id="btnConnect">BAÄžLAN</button>
    </div>

    <h2>Komutlar</h2>
    <div class="button-group">
        <button id="btnStart" class="disabled">START</button>
        <button id="btnStop"  class="disabled">STOP</button>
        <button id="btnReset" class="disabled">RESET</button>
    </div>
</div>

<script>
let device, server, service;
let cmdChar, notifyChar;
let reconnectTimer = null;

const pinLedBox = document.getElementById("pinLedBox");
const pinLed = document.getElementById("pinLed");
const pinText = document.getElementById("pinText");

const btnConnect = document.getElementById("btnConnect");
const buttons = [
    document.getElementById("btnStart"),
    document.getElementById("btnStop"),
    document.getElementById("btnReset")
];

function vibrate() {
    if (navigator.vibrate) navigator.vibrate(70);
}

function setButtons(on) {
    buttons.forEach(b => b.classList.toggle("disabled", !on));
}

async function connectBLE(auto=false) {
    try {
        if (!auto) {
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: "KOMPRESOR" }],
                optionalServices: ["00001234-0000-1000-8000-00805f9b34fb"]
            });
            device.addEventListener("gattserverdisconnected", onDisconnect);
        }

        server = await device.gatt.connect();
        service = await server.getPrimaryService("00001234-0000-1000-8000-00805f9b34fb");

        cmdChar = await service.getCharacteristic("0000abcd-0000-1000-8000-00805f9b34fb");
        notifyChar = await service.getCharacteristic("0000dcba-0000-1000-8000-00805f9b34fb");

        /* ðŸ”” NOTIFY */
        await notifyChar.startNotifications();

        /* ðŸ”¥ Ä°LK STATE'Ä° ZORLA OKU */
        const val = await notifyChar.readValue();
        updatePinLed(new TextDecoder().decode(val));

        notifyChar.oncharacteristicvaluechanged = e => {
            updatePinLed(new TextDecoder().decode(e.target.value));
        };

        pinLedBox.style.display = "flex";
        btnConnect.innerText = "BAÄžLI";
        setButtons(true);

        if (reconnectTimer) {
            clearInterval(reconnectTimer);
            reconnectTimer = null;
        }
    } catch {}
}

function updatePinLed(v) {
    pinLedBox.style.display = "flex";
    if (v === "1") {
        pinLed.style.background = "lime";
        pinText.innerText = "AÃ‡IK";
    } else {
        pinLed.style.background = "red";
        pinText.innerText = "KAPALI";
    }
}

function onDisconnect() {
    pinLedBox.style.display = "none";
    btnConnect.innerText = "BAÄžLAN";
    setButtons(false);

    reconnectTimer = setInterval(() => {
        if (device) connectBLE(true);
    }, 3000);
}

btnConnect.onclick = () => {
    vibrate();
    connectBLE(false);
};

buttons[0].onclick = () => { vibrate(); cmdChar.writeValue(new TextEncoder().encode("START")); };
buttons[1].onclick = () => { vibrate(); cmdChar.writeValue(new TextEncoder().encode("STOP")); };
buttons[2].onclick = () => { vibrate(); cmdChar.writeValue(new TextEncoder().encode("RESET")); };
</script>

</body>
</html>


